name: Deploy App Builder

# Triggers only when App Builder actions, web-src, or config change on main.
# Prevents unnecessary deploys when only EDS CSS/JS or AEM backend changes.
on:
  push:
    branches:
      - main
    paths:
      - 'app-builder/actions/**'
      - 'app-builder/web-src/**'
      - 'app-builder/app.config.yaml'
      - 'app-builder/package.json'
  workflow_dispatch: {}

concurrency:
  group: deploy-app-builder
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ─── Validate before deploy ─────────────────────────────────────────────
  test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app-builder/package.json

      - name: Install dependencies
        working-directory: app-builder
        run: npm ci --ignore-scripts

      - name: Lint
        working-directory: app-builder
        run: npm run lint

      - name: Unit tests
        working-directory: app-builder
        run: npm test

  # ─── Deploy Actions & Web UI ────────────────────────────────────────────
  deploy:
    name: Deploy to I/O Runtime
    runs-on: ubuntu-latest
    needs: test
    environment: production
    env:
      AIO_IMS_CONTEXT_CONFIG: ${{ secrets.AIO_IMS_CONTEXT_CONFIG }}
      AIO_PROJECT_ID: ${{ secrets.AIO_PROJECT_ID }}
      AIO_WORKSPACE_ID: ${{ secrets.AIO_WORKSPACE_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Adobe I/O CLI
        run: npm install -g @adobe/aio-cli

      - name: Install dependencies
        working-directory: app-builder
        run: npm ci --ignore-scripts

      - name: Deploy App Builder (actions + web-src)
        working-directory: app-builder
        run: aio app deploy
